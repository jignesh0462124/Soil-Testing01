<!DOCTYPE html>
<html lang="en">

<head>
  <title>SoilHive | Advanced Soil Analytics</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- Leaflet & Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

  <!-- App Config -->
  <script src="firebase-config.js"></script>

  <style>
    :root {
      --primary: #7C4DFF;
      --secondary: #00E5FF;
      --glass: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.5);
      --text-dark: #1A1A1A;
      --text-light: #666;
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      overflow: hidden;
      /* Full screen app feel */
      height: 100vh;
      width: 100vw;
      background-color: #f0f2f5;
    }

    /* Full Screen Map */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      background: #09090b;
      /* Dark background before map loads */
    }

    /* Hood Map Label Style */
    .hood-label {
      background: transparent;
      border: none;
      box-shadow: none;
      color: rgba(255, 255, 255, 0.9);
      font-family: 'Outfit', sans-serif;
      font-weight: 800;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      text-align: center;
    }

    /* Floating UI Overlay - Main Container */
    .ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      pointer-events: none;
      /* Let clicks pass through to map where empty */
      display: grid;
      grid-template-columns: 380px 1fr 340px;
      grid-template-rows: auto 1fr;
      padding: 24px;
      gap: 24px;
    }

    /* Sidebar (Glassmorphism) */
    .sidebar {
      grid-row: 1 / -1;
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      pointer-events: auto;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: calc(100vh - 48px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Detail Panel & History Panel (Right Side) */
    .side-panel {
      grid-column: 3;
      grid-row: 1 / -1;
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      pointer-events: auto;
      display: flex;
      flex-direction: column;
      padding: 24px;
      transform: translateX(120%);
      /* Hidden by default */
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      z-index: 1002;
    }

    .side-panel.active {
      transform: translateX(0);
    }

    /* Search Bar Overlay */
    .search-container {
      padding: 24px;
      background: rgba(255, 255, 255, 0.4);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .profile-section {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: auto;
      cursor: pointer;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      transition: background 0.2s;
    }

    .profile-section:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #1a1a1a, #4a4a4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .search-box {
      position: relative;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .search-box:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(124, 77, 255, 0.15);
    }

    #locationSearch {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: none;
      background: transparent;
      font-size: 16px;
      font-family: inherit;
      border-radius: 16px;
      outline: none;
    }

    .search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: var(--primary);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .search-btn:hover {
      background: #6200ea;
    }

    /* Menu Buttons (Sidebar Bottom) */
    .menu-bar {
      margin-top: auto;
      padding: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      gap: 10px;
    }

    .menu-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-light);
      transition: background 0.2s;
    }

    .menu-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-dark);
    }

    .menu-btn svg {
      width: 24px;
      height: 24px;
      stroke-width: 2px;
    }

    /* Results Area */
    .results-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Ingredient Cards */
    .ingredient-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      padding-bottom: 20px;
    }

    .ingredient-card {
      background: white;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .ingredient-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }

    .ingredient-card.active {
      background: #f4f0ff;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(124, 77, 255, 0.2);
    }

    .ingredient-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 4px;
      background: rgba(0, 0, 0, 0.03);
    }

    .ingredient-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
      line-height: 1.2;
    }

    .ingredient-type {
      font-size: 11px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Details & History Styling */
    .detail-header {
      margin-bottom: 20px;
      text-align: center;
    }

    .detail-icon-large {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      border-radius: 50%;
      font-size: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(124, 77, 255, 0.1);
      color: var(--primary);
    }

    .property-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-size: 14px;
    }

    .property-label {
      color: var(--text-light);
      font-weight: 500;
    }

    .property-value {
      color: var(--text-dark);
      font-weight: 600;
      text-align: right;
      max-width: 60%;
    }

    .history-item {
      background: white;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .history-item:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* Color Coding Classes */
    .color-nitrogen {
      border-color: #4CAF50;
    }

    .color-nitrogen .ingredient-icon {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }

    .color-phosphorus {
      border-color: #FF9800;
    }

    .color-phosphorus .ingredient-icon {
      background: rgba(255, 152, 0, 0.1);
      color: #FF9800;
    }

    .color-potassium {
      border-color: #E91E63;
    }

    .color-potassium .ingredient-icon {
      background: rgba(233, 30, 99, 0.1);
      color: #E91E63;
    }

    .color-ph {
      border-color: #2196F3;
    }

    .color-ph .ingredient-icon {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
    }

    .color-organic {
      border-color: #795548;
    }

    .color-organic .ingredient-icon {
      background: rgba(121, 85, 72, 0.1);
      color: #795548;
    }

    .color-default {
      border-color: #9E9E9E;
    }

    /* Quick Stats Row */
    .quick-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }

    .quick-stat-pill {
      background: white;
      padding: 8px 16px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .quick-stat-pill:hover {
      transform: translateY(-2px);
      background: #f8f9fa;
    }

    /* Loading State */
    .loader-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .loader-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(124, 77, 255, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .ui-overlay {
        grid-template-columns: 350px 1fr;
      }

      .side-panel {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 340px;
        z-index: 50;
      }
    }

    @media (max-width: 768px) {
      .ui-overlay {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        padding: 0;
        gap: 0;
      }

      .sidebar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        border-radius: 24px 24px 0 0;
        max-height: 50vh;
        border-left: none;
        border-right: none;
        border-bottom: 60px;
        /* Space for menu bar */
      }

      .side-panel {
        width: 100%;
        top: auto;
        bottom: 0;
        height: 70vh;
        transform: translateY(120%);
      }

      .side-panel.active {
        transform: translateY(0);
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>

<body>

  <div id="map"></div>

  <div class="ui-overlay">

    <!-- Side Panel (Left) -->
    <div class="sidebar">

      <!-- Search Header -->
      <div class="search-container">
        <div class="logo-area">
          <div class="logo-icon">üå±</div>
          <div class="app-title">SoilHive</div>
          <!-- User Profile Trigger -->
          <div class="profile-section" onclick="openProfile()">
            <div id="userAvatar"
              style="width: 24px; height: 24px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              üë§</div>
            <span id="userName" style="font-size: 13px; font-weight: 600;">Guest</span>
          </div>
        </div>

        <div class="search-box">
          <input type="text" id="locationSearch" placeholder="Search location..."
            onkeypress="if(event.key==='Enter') searchLocation()">
          <button class="search-btn" onclick="searchLocation()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </button>
        </div>

        <div class="quick-stats" style="margin-top: 16px;">
          <div class="quick-stat-pill" onclick="setLocation(28.6139, 77.2090)">üáÆüá≥ New Delhi</div>
          <div class="quick-stat-pill" onclick="setLocation(51.5074, -0.1278)">üá¨üáß London</div>
          <div class="quick-stat-pill" onclick="setLocation(40.7128, -74.0060)">üá∫üá∏ New York</div>
        </div>
      </div>

      <!-- Scrollable Results -->
      <div class="results-area" id="resultsArea">
        <div style="text-align: center; color: var(--text-light); margin-top: 40px;">
          <div style="font-size: 48px; margin-bottom: 16px;">üåç</div>
          <h3>Explore Soil Data</h3>
          <p style="font-size: 14px; margin-top: 8px;">Select a location on the map or search to analyze soil
            ingredients.</p>
        </div>
      </div>

      <!-- Bottom Menu -->
      <div class="menu-bar">
        <button class="menu-btn" onclick="openHistory()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          History
        </button>
        <button class="menu-btn">
          <!-- Future Feature -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          Save Report
        </button>
        <button class="menu-btn" onclick="handleLogout()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          Logout
        </button>
      </div>
    </div>

    <!-- Detail/History Panel (Right) -->
    <div class="side-panel" id="rightPanel">
      <button onclick="closePanel()"
        style="align-self: flex-end; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light);">√ó</button>
      <div id="panelContent">
        <!-- Populated by JS -->
      </div>
    </div>

  </div>

  <!-- Loader -->
  <div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <div style="margin-top: 16px; font-weight: 600; color: var(--primary);">Analyzing Soil Composition...</div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    let map;
    let marker;
    let hoodLayers;
    let currentItems = [];
    let currentUser = null;
    let authReady = false;

    // 1. Auth Guard & Initialization with enhanced error handling
    // We wait for Firebase to check the user state
    if (window.auth && window.db) {
      console.log("‚úÖ Firebase services available");
      
      auth.onAuthStateChanged(user => {
        if (user) {
          // User is logged in
          try {
            currentUser = user;
            authReady = true;

            console.log("‚úÖ User authenticated:", user.email);
            console.log("üìß Email verified:", user.emailVerified);

            // Name Update
            const nameEl = document.getElementById('userName');
            if (nameEl) nameEl.innerText = user.displayName || user.email.split('@')[0];

            // Avatar Update
            const avatarEl = document.getElementById('userAvatar');
            if (avatarEl) {
              if (user.photoURL) {
                avatarEl.innerHTML = `<img src="${user.photoURL}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                avatarEl.style.background = 'transparent';
              } else {
                avatarEl.innerHTML = 'üë§';
              }
            }

            initApp();
          } catch (error) {
            console.error("‚ùå Error setting up user:", error);
            alert("Error loading user profile. Please refresh the page.");
          }
        } else {
          // Not logged in -> Redirect to Login
          console.log("‚ö†Ô∏è  No user logged in, redirecting to login...");
          authReady = true;
          window.location.href = 'login.html';
        }
      }, (error) => {
        console.error("‚ùå Auth state change error:", error);
        authReady = true;
        alert("Authentication error: " + error.message);
        window.location.href = 'login.html';
      });
    } else {
      console.error("‚ùå Firebase Auth or Firestore not loaded");
      alert("Firebase services not available. Please check your internet connection and refresh.");
      authReady = true;
    }

    function initApp() {
      console.log("üöÄ Initializing app...");
      if (!map) initMap();
    }

    // Initialize Map
    function initMap() {
      map = L.map('map', {
        zoomControl: false // Hide default zoom for cleaner look
      }).setView([20.5937, 78.9629], 5); // Default to India

      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);

      L.control.zoom({ position: 'bottomright' }).addTo(map);
      hoodLayers = L.layerGroup().addTo(map);

      map.on('click', function (e) {
        updateLocationMarker(e.latlng.lat, e.latlng.lng);
        fetchSoilData(e.latlng.lat, e.latlng.lng);
      });
    }

    function updateLocationMarker(lat, lng) {
      if (marker) map.removeLayer(marker);
      hoodLayers.clearLayers();
      closePanel();

      marker = L.marker([lat, lng]).addTo(map);
      map.flyTo([lat, lng], 13, { duration: 1.5 });
    }

    function setLocation(lat, lon) {
      updateLocationMarker(lat, lon);
      fetchSoilData(lat, lon);
    }

    async function searchLocation() {
      const query = document.getElementById('locationSearch').value;
      if (!query) return;

      showLoader(true);
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          updateLocationMarker(lat, lon);
          fetchSoilData(lat, lon, query); // Save history with query name
        } else {
          alert('Location not found');
        }
      } catch (e) {
        console.error(e);
      } finally {
        showLoader(false);
      }
    }

    async function fetchSoilData(lat, lon, label = null) {
      showLoader(true);
      const resultsArea = document.getElementById('resultsArea');

      try {
        // Save to History (Firestore)
        if (currentUser) {
          const historyRef = db.collection('users').doc(currentUser.uid).collection('history');
          historyRef.add({
            lat: lat,
            lon: lon,
            label: label || `${lat.toFixed(2)}, ${lon.toFixed(2)}`,
            timestamp: new Date().toISOString()
          });
        }

        const response = await fetch(`http://localhost:3000/api/test-token?lat=${lat}&lon=${lon}`);
        const data = await response.json();

        if (data.success && data.properties && data.properties.items) {
          currentItems = data.properties.items;
          renderIngredients(currentItems, lat, lon);
        } else {
          resultsArea.innerHTML = `<div style="text-align:center; padding: 20px;">No data available for this location.</div>`;
        }

      } catch (error) {
        console.error("Fetch error:", error);
        resultsArea.innerHTML = `<div style="text-align:center; color: red;">Error connecting to SoilHive API. ensure server is running.</div>`;
      } finally {
        showLoader(false);
      }
    }

    function renderIngredients(items, lat, lon) {
      const resultsArea = document.getElementById('resultsArea');

      let html = `
          <div style="margin-bottom: 24px;">
            <h4 style="color: var(--text-light); font-weight: 500; font-size: 14px;">Analysis for</h4>
            <h2 style="font-size: 24px; color: var(--text-dark);">${lat.toFixed(4)}¬∞N, ${lon.toFixed(4)}¬∞E</h2>
          </div>
          
          <h3 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            <span style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></span>
            Detected Constituents
          </h3>
          
          <div class="ingredient-grid">
        `;

      items.forEach((item, index) => {
        const style = getIngredientStyle(item.name);
        html += `
            <div class="ingredient-card ${style.class}" onclick="visualizeIngredient(${index}, this)">
              <div class="ingredient-icon">${style.icon}</div>
              <div class="ingredient-name">${item.name}</div>
              <div class="ingredient-type">${style.label}</div>
            </div>
          `;
      });

      html += `</div>`;
      resultsArea.innerHTML = html;
    }

    // Hood Map Logic
    function visualizeIngredient(index, cardElement) {
      if (!marker) return;

      document.querySelectorAll('.ingredient-card').forEach(c => c.classList.remove('active'));
      cardElement.classList.add('active');

      const item = currentItems[index];
      const style = getIngredientStyle(item.name);
      const latLng = marker.getLatLng();

      hoodLayers.clearLayers();
      const color = getComputedStyle(cardElement).borderColor || '#7C4DFF';

      const circle = L.circle(latLng, {
        color: color, fillColor: color, fillOpacity: 0.2, radius: 1500, weight: 2
      }).addTo(hoodLayers);

      circle.bindTooltip(item.name, { permanent: true, direction: 'center', className: 'hood-label' }).openTooltip();
      showDetails(item, style);
    }

    function showDetails(item, style) {
      const panel = document.getElementById('rightPanel');
      const content = document.getElementById('panelContent');

      content.innerHTML = `
          <div class="detail-header">
            <div class="detail-icon-large" style="color: ${style.class.includes('nitrogen') ? '#4CAF50' : '#7C4DFF'}; background: ${style.class.includes('nitrogen') ? 'rgba(76, 175, 80, 0.1)' : 'rgba(124, 77, 255, 0.1)'}">
              ${style.icon}
            </div>
            <h2 style="font-size: 20px; font-weight: 700; color: var(--text-dark);">${item.name}</h2>
            <div style="color: var(--text-light); font-size: 14px; margin-top: 4px;">${style.label}</div>
          </div>

          <div class="property-list">
            ${item.description ? `<div style="background: rgba(0,0,0,0.02); padding: 12px; border-radius: 12px; margin-bottom: 16px; font-size: 13px; line-height: 1.5; color: var(--text-light);">${item.description}</div>` : ''}
            <div class="property-row"><span class="property-label">Category</span><span class="property-value">${item.type || 'N/A'}</span></div>
            ${item.unitText ? `<div class="property-row"><span class="property-label">Unit</span><span class="property-value">${item.unitText}</span></div>` : ''}
          </div>
        `;
      panel.classList.add('active');
    }

    // History & Profile Panel Logic
    async function openHistory() {
      const panel = document.getElementById('rightPanel');
      const content = document.getElementById('panelContent');

      content.innerHTML = `<h2 style="margin-bottom:16px;">Search History</h2><div id="historyList">Loading...</div>`;
      panel.classList.add('active');

      if (!currentUser) return;

      const snapshot = await db.collection('users').doc(currentUser.uid).collection('history').orderBy('timestamp', 'desc').limit(20).get();
      const listDiv = document.getElementById('historyList');

      if (snapshot.empty) {
        listDiv.innerHTML = "No history yet.";
        return;
      }

      let html = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `
            <div class="history-item" onclick="setLocation(${d.lat}, ${d.lon})">
              <div>
                <div style="font-weight:600;">${d.label}</div>
                <div style="font-size:12px; color:#999;">${new Date(d.timestamp).toLocaleDateString()}</div>
              </div>
              <div style="color:var(--primary);">‚û§</div>
            </div>
          `;
      });
      listDiv.innerHTML = html;
    }

    function openProfile() {
      const panel = document.getElementById('rightPanel');
      const content = document.getElementById('panelContent');
      if (!currentUser) return;

      content.innerHTML = `
            <h2 style="margin-bottom: 24px;">User Profile</h2>
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                     ${currentUser.photoURL ? `<img src="${currentUser.photoURL}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 'üë§'}
                </div>
                <h3>${currentUser.displayName || 'User'}</h3>
                <div style="color: #666; font-size: 14px;">${currentUser.email}</div>
            </div>
            
            <div style="background: rgba(0,0,0,0.03); padding: 16px; border-radius: 12px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Account Status</div>
                <div style="font-size: 14px; color: green;">‚úÖ Email Verified</div>
                <div style="font-size: 14px; margin-top: 4px;">Created: ${currentUser.metadata.creationTime}</div>
            </div>
        `;
      panel.classList.add('active');
    }

    function closePanel() {
      document.getElementById('rightPanel').classList.remove('active');
      document.querySelectorAll('.ingredient-card').forEach(c => c.classList.remove('active'));
      hoodLayers.clearLayers();
    }

    function handleLogout() {
      if (!auth) {
        alert("Auth not initialized");
        return;
      }

      try {
        auth.signOut().then(() => {
          console.log("‚úÖ User logged out successfully");
          window.location.href = 'login.html';
        }).catch(error => {
          console.error("‚ùå Logout error:", error);
          alert("Error logging out: " + error.message);
        });
      } catch (error) {
        console.error("‚ùå Logout error:", error);
      }
    }

    function getIngredientStyle(name) {
      const lowerName = name.toLowerCase();
      if (lowerName.includes('nitrogen') || lowerName.includes('nitrate')) return { class: 'color-nitrogen', icon: 'üåø', label: 'Nutrient' };
      else if (lowerName.includes('phosphorus') || lowerName.includes('phosphate')) return { class: 'color-phosphorus', icon: 'üîã', label: 'Nutrient' };
      else if (lowerName.includes('potassium')) return { class: 'color-potassium', icon: '‚ö°', label: 'Nutrient' };
      else if (lowerName.includes('ph') || lowerName.includes('acidity')) return { class: 'color-ph', icon: 'üíß', label: 'Chemical' };
      else if (lowerName.includes('organic') || lowerName.includes('carbon')) return { class: 'color-organic', icon: 'üçÇ', label: 'Biological' };
      else return { class: 'color-default', icon: 'üß™', label: 'Property' };
    }

    function showLoader(show) {
      const loader = document.getElementById('loader');
      if (show) loader.classList.add('active');
      else loader.classList.remove('active');
    }

  </script>
</body>

</html>