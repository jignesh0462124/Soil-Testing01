<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | SoilHive</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- Leaflet & Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>

  <style>
    /* Dashboard Specific Scroll Handling */
    body {
      overflow: hidden;
      /* Map takes full screen */
    }

    #soil-map {
      width: 100vw;
      height: 100vh;
      z-index: 1;
      background: #09090b;
    }

    /* Floating Sidebar */
    .sidebar {
      position: absolute;
      top: 24px;
      left: 24px;
      bottom: 24px;
      width: 380px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 16px;
      pointer-events: none;
      /* Let clicks pass through gaps */
    }

    .sidebar>* {
      pointer-events: auto;
      /* Re-enable clicks on children */
    }

    .logo-panel {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.05);
      /* Solid-ish overlay */
      border-radius: 20px;
      font-size: 13px;
    }

    .search-panel {
      padding: 20px;
    }

    .filter-panel-wrapper {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      padding: 0 4px;
      /* Space for scrollbar */
    }

    /* Details Panel */
    #details-panel {
      overflow-y: auto;
      max-height: 50vh;
      /* Don't take up too much vertical space if short on height */
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        bottom: 0;
        pointer-events: none;
        gap: 12px;
        padding: 12px;
      }

      .sidebar>* {
        pointer-events: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .filter-panel-wrapper {
        display: none;
        /* Hide filters on mobile initially */
      }

      #details-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 60vh;
        border-radius: 20px 20px 0 0;
        border-bottom: none;
      }
    }
  </style>
</head>

<body>

  <!-- Map Container -->
  <div id="soil-map"></div>

  <!-- UI Overlay -->
  <div class="sidebar">
    <!-- Header -->
    <div class="glass-card logo-panel">
      <div class="logo-text">
        <span style="font-size: 28px;">ðŸŒ±</span> SoilHive
      </div>
      <div class="user-profile" onclick="handleLogout()">
        <div id="userAvatar">ðŸ‘¤</div>
        <span id="userName">User</span>
        <span style="font-size: 10px; margin-left: 4px;">â–¼</span>
      </div>
    </div>

    <!-- Search -->
    <div class="glass-card search-panel">
      <div class="input-group" style="margin-bottom: 0;">
        <div style="position: relative;">
          <input type="text" id="locationSearch" class="input-field" placeholder="Search location..."
            style="padding-right: 48px;" onkeypress="if(event.key==='Enter') searchLocation()">
          <button class="btn" onclick="searchLocation()"
            style="position: absolute; right: 4px; top: 4px; padding: 10px; min-width: auto; background: var(--primary); color: white;">
            Wait
          </button>
          <!-- Replaced text with icon via JS below -->
        </div>
      </div>
    </div>

    <!-- Soil Details Panel (New) -->
    <div id="details-panel" class="glass-card" style="padding: 20px; display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h4 style="margin: 0; font-size: 16px; color: var(--text-main);">Analysis Report</h4>
        <button onclick="window.mapManager.closeDetails()"
          style="background:none; border:none; color:var(--text-muted); cursor:pointer;">âœ•</button>
      </div>

      <!-- Location Info -->
      <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
        <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
          Selected Location</div>
        <div id="detail-location" style="font-weight: 500;">-</div>
      </div>

      <!-- Main Stats Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted);">pH Level</div>
          <div id="detail-ph" style="font-size: 18px; font-weight: 700; color: white;">-</div>
          <div id="detail-ph-msg" style="font-size: 11px; margin-top: 4px;">-</div>
        </div>
        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted);">Soil Type</div>
          <div id="detail-type" style="font-size: 16px; font-weight: 600; text-transform: capitalize;">-</div>
        </div>
        <!-- New Ingredients -->
        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted);">Moisture</div>
          <div id="detail-moisture" style="font-size: 18px; font-weight: 700; color: #40C4FF;">-</div>
        </div>
        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: var(--text-muted);">Organic Matter</div>
          <div id="detail-organic" style="font-size: 18px; font-weight: 700; color: #69F0AE;">-</div>
        </div>
        <div style="background: var(--bg-dark); padding: 12px; border-radius: 8px; grid-column: span 2;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size: 12px; color: var(--text-muted);">Elec. Conductivity</div>
            <div id="detail-conductivity" style="font-size: 16px; font-weight: 600; color: white;">-</div>
          </div>
        </div>
      </div>

      <!-- NPK Values -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase;">Nutrient
          Levels (NPK)</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: flex; justify-content: space-between; font-size: 13px;">
            <span>Nitrogen (N)</span>
            <span id="detail-n" style="font-weight: 600;">-</span>
          </div>
          <div class="progress-bar"
            style="height: 6px; background: var(--bg-dark); border-radius: 10px; overflow: hidden;">
            <div id="bar-n" style="width: 0%; height: 100%; background: #00E676; transition: width 0.5s;"></div>
          </div>

          <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
            <span>Phosphorus (P)</span>
            <span id="detail-p" style="font-weight: 600;">-</span>
          </div>
          <div class="progress-bar"
            style="height: 6px; background: var(--bg-dark); border-radius: 10px; overflow: hidden;">
            <div id="bar-p" style="width: 0%; height: 100%; background: #FF9100; transition: width 0.5s;"></div>
          </div>

          <div style="display: flex; justify-content: space-between; font-size: 13px; margin-top: 4px;">
            <span>Potassium (K)</span>
            <span id="detail-k" style="font-weight: 600;">-</span>
          </div>
          <div class="progress-bar"
            style="height: 6px; background: var(--bg-dark); border-radius: 10px; overflow: hidden;">
            <div id="bar-k" style="width: 0%; height: 100%; background: #651FFF; transition: width 0.5s;"></div>
          </div>
        </div>
      </div>

      <!-- Recommendation Box -->
      <div id="recommendation-box"
        style="background: rgba(124, 77, 255, 0.1); border: 1px solid var(--primary); padding: 12px; border-radius: 8px;">
        <div style="display: flex; gap: 8px; align-items: start;">
          <span>ðŸ’¡</span>
          <div>
            <div style="font-weight: 600; font-size: 13px; color: var(--primary); margin-bottom: 4px;">Recommendation
            </div>
            <div id="detail-rec" style="font-size: 12px; line-height: 1.4; color: var(--text-main);">Select a location
              to see recommendations.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dynamic Filter Container from soil-map.js -->
    <div class="glass-card filter-panel-wrapper">
      <div id="filter-container">
        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
          Loading filters...
        </div>
      </div>
    </div>
  </div>

  <!-- Legend Container -->
  <div id="legend-container"></div>

  <!-- Loader -->
  <div id="loader" class="glass-card"
    style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; z-index: 2000; display: none; flex-direction: column; align-items: center;">
    <div class="spinner" style="width: 40px; height: 40px; border-width: 3px;"></div>
    <div style="margin-top: 16px; font-weight: 600; color: var(--primary);">Processing Data...</div>
  </div>

  <!-- Logic -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- soil-map.js must be loaded AFTER Leaflet -->
  <script src="soil-map.js"></script>

  <script>
    // Init Button Icon
    document.querySelector('.search-panel button').innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        `;

    // Auth Logic
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('userName').innerText = user.displayName || user.email.split('@')[0];
        if (user.photoURL) {
          document.getElementById('userAvatar').innerHTML = `<img src="${user.photoURL}" style="width:24px;height:24px;border-radius:50%;">`;
        }

        // Initialize Map if not already
        if (window.mapManager && !window.mapManager.initialized) {
          window.mapManager.initializeMap();
        }
      } else {
        window.location.href = 'login.html';
      }
    });

    // Logout
    function handleLogout() {
      if (confirm('Are you sure you want to log out?')) {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      }
    }

    // Search Logic
    async function searchLocation() {
      const query = document.getElementById('locationSearch').value;
      if (!query) return;

      document.getElementById('loader').style.display = 'flex';

      try {
        // Use Nominatim for geocoding
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);

          if (window.mapManager && window.mapManager.map) {
            window.mapManager.map.flyTo([lat, lon], 13, { duration: 1.5 });
            // Add temporary marker
            L.marker([lat, lon]).addTo(window.mapManager.map)
              .bindPopup(`<b>${data[0].display_name}</b>`)
              .openPopup();
          }
        } else {
          alert('Location not found');
        }
      } catch (e) {
        console.error(e);
        alert('Search failed. Please try again.');
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    // Ensure Map Inits
    setTimeout(() => {
      if (window.mapManager && !window.mapManager.initialized) {
        window.mapManager.initializeMap();
      }
    }, 1000);

  </script>
</body>

</html>